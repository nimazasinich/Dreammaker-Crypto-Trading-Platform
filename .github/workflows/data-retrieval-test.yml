name: Data Retrieval System Tests

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'src/services/**'
      - 'src/core/ProviderManager.ts'
      - 'src/core/DataFallbackManager.ts'
      - 'config/api.json'
      - 'config/providers_config.json'
      - 'config/exchanges.json'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'src/services/**'
      - 'src/core/ProviderManager.ts'
      - 'config/**'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - full
          - integration

jobs:
  validate-config:
    name: Validate Data Source Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Data Sources
        run: node scripts/validate-data-sources.js
        continue-on-error: true

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: |
            validation-report.json
          retention-days: 7

  test-data-retrieval:
    name: Test Data Retrieval Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate-config

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build server
        run: npm run build:server
        env:
          NODE_ENV: test

      - name: Start server in background
        run: |
          npm run start:server &
          sleep 10
          echo "Server started"
        env:
          NODE_ENV: test
          PRIMARY_DATA_SOURCE: huggingface
          HF_ENGINE_ENABLED: true
          HF_ENGINE_BASE_URL: /api/hf-engine

      - name: Wait for server to be ready
        run: |
          timeout=60
          elapsed=0
          while ! curl -f http://localhost:8000/api/health > /dev/null 2>&1; do
            if [ $elapsed -ge $timeout ]; then
              echo "Server failed to start within $timeout seconds"
              exit 1
            fi
            echo "Waiting for server... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "Server is ready!"

      - name: Run data retrieval tests
        run: |
          chmod +x scripts/test-data-retrieval.sh
          BASE_URL=http://localhost:8000 ./scripts/test-data-retrieval.sh || true
        continue-on-error: true

      - name: Test provider endpoints
        run: |
          echo "Testing provider endpoints..."
          curl -f http://localhost:8000/api/providers/status || echo "Provider status check failed"
          curl -f http://localhost:8000/api/providers/categories || echo "Provider categories check failed"
        continue-on-error: true

      - name: Test market data endpoints
        run: |
          echo "Testing market data endpoints..."
          curl -f "http://localhost:8000/api/market/prices" || echo "Market prices check failed"
          curl -f "http://localhost:8000/api/config/data-source" || echo "Data source config check failed"
        continue-on-error: true

      - name: Stop server
        if: always()
        run: |
          pkill -f "node.*server" || true
          echo "Server stopped"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
          retention-days: 7

  integration-test:
    name: Integration Tests (Full)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.test_level == 'full' || github.event_name == 'workflow_dispatch'
    needs: [validate-config]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: |
          echo "Running full integration tests..."
          # Add comprehensive integration tests here
          npm run test:integration || true
        continue-on-error: true
        env:
          NODE_ENV: test
          PRIMARY_DATA_SOURCE: huggingface

  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [validate-config, test-data-retrieval]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate summary report
        run: |
          echo "## Data Retrieval Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.validate-config.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoint Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.test-data-retrieval.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Report" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed test results." >> $GITHUB_STEP_SUMMARY
