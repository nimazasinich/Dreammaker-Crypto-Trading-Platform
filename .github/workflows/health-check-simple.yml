name: Backend & API Healthâ€‘Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ù‡Ø± 6 Ø³Ø§Ø¹Øª ÛŒÚ© Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ù…Ø­ÛŒØ· ØªØ³Øª'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  health-check:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # ØªØ³Øª Ù‡Ø± Ø¯Ùˆ Ù…Ø­ÛŒØ· staging Ùˆ production
        environment: [staging, production]
      fail-fast: false  # Ø§Ø¯Ø§Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ø­ØªÛŒ Ø§Ú¯Ø± ÛŒÚ©ÛŒ fail Ø´ÙˆØ¯

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¥ Run Health Check - ${{ matrix.environment }}
        run: |
          if [ "${{ matrix.environment }}" = "production" ]; then
            npm run health:check:prod
          elif [ "${{ matrix.environment }}" = "staging" ]; then
            npm run health:check:staging
          else
            npm run health:check:dev
          fi
        env:
          # Development
          API_BASE: http://localhost:8000
          WS_URL: ws://localhost:8000/ws

          # Staging (Ø§Ø² GitHub Secrets)
          STAGING_API_BASE: ${{ secrets.STAGING_API_BASE }}
          STAGING_WS_URL: ${{ secrets.STAGING_WS_URL }}

          # Production (Ø§Ø² GitHub Secrets)
          PROD_API_BASE: ${{ secrets.PROD_API_BASE }}
          PROD_WS_URL: ${{ secrets.PROD_WS_URL }}

      - name: ğŸ“Š Generate reports
        if: always()
        run: |
          # ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ JSON
          npm run health:check -- \
            --env ${{ matrix.environment }} \
            --parallel \
            --format json \
            --output ./reports/health-check-${{ matrix.environment }}.json

          # ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Markdown
          npm run health:check -- \
            --env ${{ matrix.environment }} \
            --parallel \
            --format markdown \
            --output ./reports/health-check-${{ matrix.environment }}.md
        env:
          STAGING_API_BASE: ${{ secrets.STAGING_API_BASE }}
          STAGING_WS_URL: ${{ secrets.STAGING_WS_URL }}
          PROD_API_BASE: ${{ secrets.PROD_API_BASE }}
          PROD_WS_URL: ${{ secrets.PROD_WS_URL }}

      - name: ğŸ“¤ Upload report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ matrix.environment }}
          path: ./reports/
          retention-days: 30

      - name: ğŸ’¬ Comment on PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = './reports/health-check-${{ matrix.environment }}.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ¥ Health Check - ${{ matrix.environment }}\n\n${report}`
              });
            }

      - name: ğŸš¨ Create issue on failure
        if: failure() && github.event_name != 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = './reports/health-check-${{ matrix.environment }}.json';
            let failedTests = '';

            if (fs.existsSync(reportPath)) {
              try {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                const failed = report.results.filter(r => !r.passed);

                if (failed.length > 0) {
                  failedTests = '\n\n### âŒ Failed Tests:\n\n';
                  failed.forEach(test => {
                    failedTests += `- **${test.name}** (${test.category})\n`;
                    failedTests += `  - Error: \`${test.error}\`\n\n`;
                  });
                }
              } catch (e) {
                failedTests = '\n\nâš ï¸ Could not parse report file\n';
              }
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Health Check Failed - ${{ matrix.environment }}`,
              body: `## ğŸ”¥ Health Check Failure\n\n` +
                    `**Environment:** ${{ matrix.environment }}\n` +
                    `**Workflow:** ${context.workflow}\n` +
                    `**Run ID:** ${context.runId}\n` +
                    `**Commit:** ${context.sha.substring(0, 7)}\n` +
                    `**Branch:** ${context.ref}\n` +
                    `**Triggered by:** ${context.eventName}\n` +
                    failedTests +
                    `\n---\n\n` +
                    `[ğŸ“Š View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                    `[ğŸ“„ Download reports](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}#artifacts)`,
              labels: ['health-check', 'bug', 'urgent', 'automated']
            });

      - name: ğŸ“¢ Notify on Slack (optional)
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš¨ Health Check Failed - ${{ matrix.environment }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ”¥ Health Check Alert"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* ${{ matrix.environment }}\n*Workflow:* ${{ github.workflow }}\n*Branch:* ${{ github.ref }}\n*Commit:* ${{ github.sha }}\n*Triggered by:* ${{ github.event_name }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“Š View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: âŒ Fail if health check failed
        if: failure()
        run: |
          echo "ğŸ”¥ Health check failed â€” aborting deployment / alerting team"
          echo "Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±ØŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± artifacts Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯"
          exit 1

  summary:
    name: ğŸ“Š Health Check Summary
    runs-on: ubuntu-latest
    needs: health-check
    if: always()

    steps:
      - name: ğŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports/

      - name: ğŸ“Š Generate combined summary
        run: |
          echo "# ğŸ¥ Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ø¨Ø±Ø±Ø³ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
          for env_dir in all-reports/health-report-*/reports; do
            if [ -d "$env_dir" ]; then
              env_name=$(basename $(dirname "$env_dir") | sed 's/health-report-//')

              for json_file in "$env_dir"/*.json; do
                if [ -f "$json_file" ]; then
                  echo "## Environment: $env_name" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if command -v jq &> /dev/null; then
                    total=$(jq -r '.total' "$json_file" 2>/dev/null || echo "N/A")
                    passed=$(jq -r '.passed' "$json_file" 2>/dev/null || echo "N/A")
                    failed=$(jq -r '.failed' "$json_file" 2>/dev/null || echo "N/A")
                    passRate=$(jq -r '.passRate' "$json_file" 2>/dev/null || echo "N/A")
                    duration=$(jq -r '.duration' "$json_file" 2>/dev/null || echo "N/A")

                    echo "- **Total Tests:** $total" >> $GITHUB_STEP_SUMMARY
                    echo "- **Passed:** $passed âœ…" >> $GITHUB_STEP_SUMMARY
                    echo "- **Failed:** $failed âŒ" >> $GITHUB_STEP_SUMMARY
                    echo "- **Pass Rate:** ${passRate}%" >> $GITHUB_STEP_SUMMARY
                    echo "- **Duration:** ${duration}ms" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âš ï¸ jq not available - install for detailed metrics" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“„ **Reports are available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY

      - name: âœ… All checks passed
        if: success()
        run: |
          echo "âœ… Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ù„Ø§Ù…Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!"
          echo "All health checks passed successfully!"

      - name: âŒ Some checks failed
        if: failure()
        run: |
          echo "âŒ Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ù„Ø§Ù…Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!"
          echo "Some health checks failed. Please review the reports and issues."
          exit 1
