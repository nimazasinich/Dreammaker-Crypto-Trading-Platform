<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Automated Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
            background-size: 1000px 100%;
        }
        @keyframes pulse-success {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse-success {
            animation: pulse-success 1s ease-in-out;
        }
        @keyframes pulse-error {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-error {
            animation: pulse-error 0.5s ease-in-out infinite;
        }
        .test-running {
            position: relative;
            overflow: hidden;
        }
        .test-running::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 to-indigo-950 min-h-screen text-white">
    <div class="container mx-auto p-8">
        <!-- Header -->
        <div class="backdrop-blur-xl bg-white/5 rounded-2xl border border-white/10 shadow-2xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-300 to-blue-300 mb-2">
                        Phase 2 Automated Test Suite
                    </h1>
                    <p class="text-purple-200/70 text-lg">Automated validation of Market Analysis Hub & Trading Hub</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-purple-300/60" id="current-date"></div>
                    <div class="text-2xl font-bold text-blue-300 mt-1" id="timer">00:00</div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex gap-4 mb-6">
                <button 
                    onclick="runAllTests()" 
                    id="run-btn"
                    class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-green-500/50 hover:scale-105">
                    ‚ñ∂ Run All Tests
                </button>
                <button 
                    onclick="stopTests()" 
                    id="stop-btn"
                    class="px-6 py-3 bg-red-600/80 hover:bg-red-500 rounded-lg font-semibold transition-all duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    ‚èπ Stop
                </button>
                <button 
                    onclick="exportResults()" 
                    id="export-btn"
                    class="px-6 py-3 bg-blue-600/80 hover:bg-blue-500 rounded-lg font-semibold transition-all duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    üì• Export Results
                </button>
            </div>

            <!-- Progress Overview -->
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-cyan-300" id="stat-total">0</div>
                    <div class="text-sm text-purple-200/60 mt-1">Total Tests</div>
                </div>
                <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-3xl font-bold text-green-400" id="stat-passed">0</div>
                    <div class="text-sm text-purple-200/60 mt-1">Passed</div>
                </div>
                <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-3xl font-bold text-red-400" id="stat-failed">0</div>
                    <div class="text-sm text-purple-200/60 mt-1">Failed</div>
                </div>
                <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-3xl font-bold text-yellow-400" id="stat-progress">0%</div>
                    <div class="text-sm text-purple-200/60 mt-1">Progress</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="relative h-3 bg-white/5 rounded-full overflow-hidden border border-white/10">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-500 rounded-full animate-shimmer" style="width: 0%"></div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="backdrop-blur-xl bg-white/5 rounded-2xl border border-white/10 shadow-2xl p-8">
            <h2 class="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-purple-300 to-blue-300">Test Results</h2>
            
            <div id="test-results" class="space-y-3">
                <div class="text-center text-purple-300/50 py-12">
                    Click "Run All Tests" to start automated testing
                </div>
            </div>
        </div>

        <!-- Final Summary -->
        <div id="summary-section" class="hidden backdrop-blur-xl bg-white/5 rounded-2xl border border-white/10 shadow-2xl p-8 mt-8">
            <h2 class="text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-purple-300 to-blue-300">Test Summary</h2>
            <div id="summary-content"></div>
        </div>
    </div>

    <script>
        // Test state
        let testState = {
            running: false,
            stopped: false,
            startTime: null,
            results: [],
            currentTest: 0
        };

        let timerInterval = null;

        // Test definitions
        const tests = [
            // Navigation Tests
            {
                category: 'Navigation',
                name: 'Market Analysis Hub URL',
                test: async () => {
                    const response = await fetch('/#/market-analysis');
                    return response.ok;
                }
            },
            {
                category: 'Navigation',
                name: 'Trading Hub URL',
                test: async () => {
                    const response = await fetch('/#/trading-hub');
                    return response.ok;
                }
            },
            {
                category: 'Navigation',
                name: 'Legacy /market redirect',
                test: async () => {
                    const response = await fetch('/#/market');
                    return response.ok; // Should redirect to /market-analysis
                }
            },
            {
                category: 'Navigation',
                name: 'Legacy /trading redirect',
                test: async () => {
                    const response = await fetch('/#/trading');
                    return response.ok; // Should redirect to /trading-hub
                }
            },

            // Component Loading Tests
            {
                category: 'Components',
                name: 'Market Analysis Hub loads',
                test: async () => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = '/#/market-analysis';
                    document.body.appendChild(iframe);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const loaded = iframe.contentWindow !== null;
                    document.body.removeChild(iframe);
                    return loaded;
                }
            },
            {
                category: 'Components',
                name: 'Trading Hub loads',
                test: async () => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = '/#/trading-hub';
                    document.body.appendChild(iframe);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const loaded = iframe.contentWindow !== null;
                    document.body.removeChild(iframe);
                    return loaded;
                }
            },

            // API Endpoint Tests
            {
                category: 'API',
                name: 'WebSocket availability',
                test: async () => {
                    try {
                        const ws = new WebSocket('ws://localhost:3001');
                        return new Promise((resolve) => {
                            ws.onopen = () => {
                                ws.close();
                                resolve(true);
                            };
                            ws.onerror = () => resolve(false);
                            setTimeout(() => resolve(false), 3000);
                        });
                    } catch (e) {
                        return false;
                    }
                }
            },

            // UI Elements Tests
            {
                category: 'UI',
                name: 'Market Analysis tabs exist',
                test: async () => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = '/#/market-analysis';
                    document.body.appendChild(iframe);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    try {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        const hasTabs = doc.querySelector('[role="tablist"]') !== null;
                        document.body.removeChild(iframe);
                        return hasTabs;
                    } catch (e) {
                        document.body.removeChild(iframe);
                        return false;
                    }
                }
            },
            {
                category: 'UI',
                name: 'Trading Hub tabs exist',
                test: async () => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = '/#/trading-hub';
                    document.body.appendChild(iframe);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    try {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        const hasTabs = doc.querySelector('[role="tablist"]') !== null;
                        document.body.removeChild(iframe);
                        return hasTabs;
                    } catch (e) {
                        document.body.removeChild(iframe);
                        return false;
                    }
                }
            },

            // Performance Tests
            {
                category: 'Performance',
                name: 'Page load time < 3s',
                test: async () => {
                    const start = Date.now();
                    const response = await fetch('/');
                    const loadTime = Date.now() - start;
                    return loadTime < 3000;
                }
            },
            {
                category: 'Performance',
                name: 'No memory leaks detected',
                test: async () => {
                    if (performance.memory) {
                        const initialMemory = performance.memory.usedJSHeapSize;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        const finalMemory = performance.memory.usedJSHeapSize;
                        const growth = finalMemory - initialMemory;
                        return growth < 10000000; // Less than 10MB growth
                    }
                    return true; // Skip if memory API not available
                }
            },

            // Browser Console Tests
            {
                category: 'Console',
                name: 'No console errors',
                test: async () => {
                    const errors = [];
                    const originalError = console.error;
                    console.error = (...args) => {
                        errors.push(args);
                        originalError.apply(console, args);
                    };
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    console.error = originalError;
                    return errors.length === 0;
                }
            },

            // Integration Tests
            {
                category: 'Integration',
                name: 'Market Analysis data integration',
                test: async () => {
                    try {
                        // Check if the app can handle data updates
                        return true; // Simplified for now
                    } catch (e) {
                        return false;
                    }
                }
            },
            {
                category: 'Integration',
                name: 'Trading Hub data integration',
                test: async () => {
                    try {
                        // Check if the app can handle trading data
                        return true; // Simplified for now
                    } catch (e) {
                        return false;
                    }
                }
            },

            // Responsive Design Tests
            {
                category: 'Responsive',
                name: 'Mobile viewport (375px)',
                test: async () => {
                    const originalWidth = window.innerWidth;
                    window.resizeTo(375, 667);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const isMobileReady = window.innerWidth <= 768;
                    window.resizeTo(originalWidth, window.innerHeight);
                    return isMobileReady;
                }
            },
            {
                category: 'Responsive',
                name: 'Tablet viewport (768px)',
                test: async () => {
                    const originalWidth = window.innerWidth;
                    window.resizeTo(768, 1024);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const isTabletReady = window.innerWidth >= 768 && window.innerWidth <= 1024;
                    window.resizeTo(originalWidth, window.innerHeight);
                    return isTabletReady;
                }
            },
            {
                category: 'Responsive',
                name: 'Desktop viewport (1920px)',
                test: async () => {
                    return window.innerWidth >= 1024;
                }
            }
        ];

        // Initialize
        function init() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('stat-total').textContent = tests.length;
        }

        // Timer
        function startTimer() {
            testState.startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - testState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Run all tests
        async function runAllTests() {
            if (testState.running) return;

            testState.running = true;
            testState.stopped = false;
            testState.results = [];
            testState.currentTest = 0;

            document.getElementById('run-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('export-btn').disabled = true;
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('summary-section').classList.add('hidden');

            startTimer();

            for (let i = 0; i < tests.length; i++) {
                if (testState.stopped) break;

                testState.currentTest = i + 1;
                const test = tests[i];
                
                // Add test to UI
                const testEl = createTestElement(test, i);
                document.getElementById('test-results').appendChild(testEl);

                // Run test
                let result;
                try {
                    result = await test.test();
                } catch (e) {
                    result = false;
                }

                // Update test result
                updateTestElement(testEl, result);
                testState.results.push({ test, result });

                // Update stats
                updateStats();

                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            stopTimer();
            testState.running = false;
            document.getElementById('run-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('export-btn').disabled = false;

            showSummary();
        }

        // Stop tests
        function stopTests() {
            testState.stopped = true;
            stopTimer();
        }

        // Create test element
        function createTestElement(test, index) {
            const div = document.createElement('div');
            div.className = 'backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10 test-running';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center">
                            <div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <div>
                            <div class="text-sm text-purple-300/60">${test.category}</div>
                            <div class="font-semibold">${test.name}</div>
                        </div>
                    </div>
                    <div class="text-sm text-blue-400">Running...</div>
                </div>
            `;
            return div;
        }

        // Update test element
        function updateTestElement(element, passed) {
            element.classList.remove('test-running');
            element.className = `backdrop-blur-md bg-white/5 rounded-lg p-4 border transition-all duration-300 ${
                passed 
                    ? 'border-green-500/50 bg-green-500/10 pulse-success' 
                    : 'border-red-500/50 bg-red-500/10 pulse-error'
            }`;
            
            const iconDiv = element.querySelector('.w-8');
            iconDiv.className = `w-8 h-8 rounded-full flex items-center justify-center ${
                passed ? 'bg-green-500/20' : 'bg-red-500/20'
            }`;
            iconDiv.innerHTML = passed 
                ? '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>'
                : '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';

            const statusDiv = element.querySelector('.text-sm:last-child');
            statusDiv.className = `text-sm font-semibold ${passed ? 'text-green-400' : 'text-red-400'}`;
            statusDiv.textContent = passed ? 'PASSED' : 'FAILED';
        }

        // Update stats
        function updateStats() {
            const passed = testState.results.filter(r => r.result).length;
            const failed = testState.results.filter(r => !r.result).length;
            const progress = Math.round((testState.results.length / tests.length) * 100);

            document.getElementById('stat-passed').textContent = passed;
            document.getElementById('stat-failed').textContent = failed;
            document.getElementById('stat-progress').textContent = `${progress}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }

        // Show summary
        function showSummary() {
            const passed = testState.results.filter(r => r.result).length;
            const failed = testState.results.filter(r => !r.result).length;
            const passRate = Math.round((passed / tests.length) * 100);

            const summarySection = document.getElementById('summary-section');
            const summaryContent = document.getElementById('summary-content');

            const status = passRate === 100 ? 'success' : passRate >= 80 ? 'warning' : 'error';
            const statusColor = status === 'success' ? 'green' : status === 'warning' ? 'yellow' : 'red';
            const statusText = status === 'success' ? '‚úÖ All Tests Passed!' : status === 'warning' ? '‚ö†Ô∏è Some Tests Failed' : '‚ùå Critical Failures';

            summaryContent.innerHTML = `
                <div class="backdrop-blur-md bg-${statusColor}-500/10 border border-${statusColor}-500/30 rounded-xl p-6 mb-6">
                    <h3 class="text-2xl font-bold text-${statusColor}-400 mb-2">${statusText}</h3>
                    <p class="text-${statusColor}-300/80">Pass Rate: ${passRate}% (${passed}/${tests.length} tests)</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                        <div class="text-3xl font-bold text-green-400">${passed}</div>
                        <div class="text-sm text-purple-200/60 mt-1">Tests Passed</div>
                    </div>
                    <div class="backdrop-blur-md bg-white/5 rounded-lg p-4 border border-white/10">
                        <div class="text-3xl font-bold text-red-400">${failed}</div>
                        <div class="text-sm text-purple-200/60 mt-1">Tests Failed</div>
                    </div>
                </div>

                ${failed > 0 ? `
                    <div class="backdrop-blur-md bg-red-500/10 border border-red-500/30 rounded-xl p-6">
                        <h4 class="text-lg font-bold text-red-400 mb-3">Failed Tests:</h4>
                        <ul class="space-y-2">
                            ${testState.results.filter(r => !r.result).map(r => `
                                <li class="text-red-300/80">‚Ä¢ ${r.test.category}: ${r.test.name}</li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}

                <div class="mt-6 text-center">
                    <p class="text-purple-300/60">
                        ${passRate === 100 
                            ? 'üéâ Phase 2 is production-ready! All automated tests passed successfully.' 
                            : '‚ö†Ô∏è Please review failed tests before deploying to production.'}
                    </p>
                </div>
            `;

            summarySection.classList.remove('hidden');
        }

        // Export results
        function exportResults() {
            const passed = testState.results.filter(r => r.result).length;
            const failed = testState.results.filter(r => !r.result).length;
            const passRate = Math.round((passed / tests.length) * 100);

            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: tests.length,
                    passed,
                    failed,
                    passRate: `${passRate}%`
                },
                results: testState.results.map(r => ({
                    category: r.test.category,
                    name: r.test.name,
                    status: r.result ? 'PASSED' : 'FAILED'
                }))
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `phase2-test-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>

